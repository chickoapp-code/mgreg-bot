# –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

## –û–±–∑–æ—Ä

–≠—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å–µ—Ä–≤–∏—Å –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π —Ç–∞–π–Ω—ã—Ö –≥–æ—Å—Ç–µ–π –Ω–∞ –≤–∞—à–µ–º —Å–µ—Ä–≤–µ—Ä–µ `http://crmbot.restme.pro`.

**üìå –°–ø–æ—Å–æ–±—ã –∑–∞–ø—É—Å–∫–∞:**
- **–°–∏—Å—Ç–µ–º–Ω–∞—è —Å–ª—É–∂–±–∞ (systemd)** - —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–± –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ (–®–∞–≥ 5)
- **–ë–µ–∑ —Å–ª—É–∂–±—ã** - –ø—Ä–æ—Å—Ç—ã–µ —Å–ø–æ—Å–æ–±—ã –∑–∞–ø—É—Å–∫–∞ (—Å–º. —Ä–∞–∑–¥–µ–ª "–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –∑–∞–ø—É—Å–∫–∞")

## –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- –°–µ—Ä–≤–µ—Ä —Å –¥–æ—Å—Ç—É–ø–æ–º –ø–æ SSH
- Python 3.11 –∏–ª–∏ –≤—ã—à–µ
- –ü—Ä–∞–≤–∞ –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫—É –ø–∞–∫–µ—Ç–æ–≤ (sudo)
- –î–æ–º–µ–Ω/–ø–æ–¥–¥–æ–º–µ–Ω, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä (crmbot.restme.pro)
- Telegram –±–æ—Ç —Ç–æ–∫–µ–Ω
- –î–æ—Å—Ç—É–ø –∫ Planfix API

---

## –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

### 1.1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É

```bash
ssh user@crmbot.restme.pro
# –∏–ª–∏
ssh user@your-server-ip
```

### 1.2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã (Ubuntu/Debian)

```bash
sudo apt update
sudo apt upgrade -y
```

### 1.3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python 3.11+ –∏ pip
sudo apt install -y python3 python3-pip python3-venv

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
sudo apt install -y git build-essential
```

### 1.4. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
sudo adduser --disabled-password --gecos "" botuser

# –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
sudo su - botuser
```

---

## –®–∞–≥ 2: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–æ–¥–∞

### 2.1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–æ–º–∞—à–Ω—é—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd ~

# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–∑–∞–º–µ–Ω–∏—Ç–µ URL –Ω–∞ –≤–∞—à)
git clone https://github.com/your-username/mgreg-bot.git

# –ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–¥ —á–µ—Ä–µ–∑ scp/rsync
cd mgreg-bot
```

### 2.2. –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
python3 -m venv .venv

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
source .venv/bin/activate
```

### 2.3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ pip
pip install --upgrade pip

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏–∑ requirements.txt
pip install -r requirements.txt
```

---

## –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

### 3.1. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ .env

```bash
# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–∞
cp env.example .env

# –û—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–∞–π–ª–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
nano .env
# –∏–ª–∏
vim .env
```

### 3.2. –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env` —Ñ–∞–π–ª –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:

```bash
# Telegram Bot Configuration
BOT_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω_telegram_–±–æ—Ç–∞

# Planfix API Configuration
PLANFIX_BASE_URL=https://conquest.planfix.ru/rest/
PLANFIX_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω_planfix
PLANFIX_TEMPLATE_ID=413

# Planfix Webhook Configuration (Basic Auth)
PLANFIX_WEBHOOK_LOGIN=–≤–∞—à_–ª–æ–≥–∏–Ω_–¥–ª—è_–≤–µ–±—Ö—É–∫–∞
PLANFIX_WEBHOOK_PASSWORD=–≤–∞—à_–ø–∞—Ä–æ–ª—å_–¥–ª—è_–≤–µ–±—Ö—É–∫–∞
PLANFIX_TASK_TEMPLATE_IDS=123,456  # ID —à–∞–±–ª–æ–Ω–æ–≤ –∑–∞–¥–∞—á —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é

# –°—Ç–∞—Ç—É—Å—ã Planfix
STATUS_DONE_ID=10          # ID —Å—Ç–∞—Ç—É—Å–∞ "–ó–∞–≤–µ—Ä—à–µ–Ω–∞/–∫ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏"
STATUS_CANCELLED_ID=11     # ID —Å—Ç–∞—Ç—É—Å–∞ "–û—Ç–º–µ–Ω–µ–Ω–∞"

# –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è Planfix
RESULT_FIELD_ID=100        # ID –ø–æ–ª—è –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (—Ç–µ–∫—Å—Ç)
RESULT_FILES_FIELD_ID=101  # ID –ø–æ–ª—è –¥–ª—è —Ñ–∞–π–ª–æ–≤ (—Ñ–∞–π–ª—ã)

# Admin Configuration
ADMIN_NAME=@–≤–∞—à_telegram_username
ADMIN_CHAT_ID=123456789    # –í–∞—à Telegram Chat ID

# Webhook Server Configuration
# –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 0.0.0.0 –¥–ª—è –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è –Ω–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö
# –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π IP –∞–¥—Ä–µ—Å - —ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É "cannot assign requested address"
WEBHOOK_HOST=0.0.0.0       # –°–ª—É—à–∞—Ç—å –Ω–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)
WEBHOOK_PORT=8001          # –ü–æ—Ä—Ç –¥–ª—è –≤–µ–±—Ö—É–∫-—Å–µ—Ä–≤–µ—Ä–∞
WEBHOOK_BASE_URL=http://crmbot.restme.pro  # –ü—É–±–ª–∏—á–Ω—ã–π URL —Å–µ—Ä–≤–µ—Ä–∞ (–¥–ª—è –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤)

# WebApp and Forms Configuration
# WEBAPP_HMAC_SECRET - —Å–µ–∫—Ä–µ—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ URL WebApp (–∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–¥–¥–µ–ª–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤)
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ sig –≤ URL –≤–∏–¥–∞:
# /webapp/start?taskId=123&guestId=456&form=resto_a&sig=abc123&ts=1234567890
# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è: python3 -c "import secrets; print(secrets.token_urlsafe(32))"
WEBAPP_HMAC_SECRET=—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ_—Å–ª—É—á–∞–π–Ω—É—é_—Å—Ç—Ä–æ–∫—É_–¥–ª—è_–ø–æ–¥–ø–∏—Å–∏_webapp

# YFORMS_WEBHOOK_SECRET - —Å–µ–∫—Ä–µ—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç –Ø–Ω–¥–µ–∫—Å –§–æ—Ä–º
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ X-Forms-Signature –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö –æ—Ç —Ñ–æ—Ä–º
# –≠—Ç–æ—Ç –∂–µ —Å–µ–∫—Ä–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –≤–µ–±—Ö—É–∫–∞ –∫–∞–∂–¥–æ–π –Ø–Ω–¥–µ–∫—Å –§–æ—Ä–º—ã
# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è: python3 -c "import secrets; print(secrets.token_urlsafe(32))"
YFORMS_WEBHOOK_SECRET=—Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ_—Å–ª—É—á–∞–π–Ω—É—é_—Å—Ç—Ä–æ–∫—É_–¥–ª—è_–≤–µ–±—Ö—É–∫–æ–≤_—Ñ–æ—Ä–º

# Form URLs (6 —Ñ–æ—Ä–º —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
# –§–æ—Ä–º–∞—Ç: resto_a,resto_b,resto_c,delivery_a,delivery_b,delivery_c
FORM_URLS=https://forms.yandex.ru/u/resto_a,https://forms.yandex.ru/u/resto_b,https://forms.yandex.ru/u/resto_c,https://forms.yandex.ru/u/delivery_a,https://forms.yandex.ru/u/delivery_b,https://forms.yandex.ru/u/delivery_c

# Database Configuration
DATABASE_PATH=bot.db       # –ü—É—Ç—å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö SQLite
```

### 3.3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–æ–≤

–î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–∏–Ω –∏–∑ —Å–ø–æ—Å–æ–±–æ–≤:

**–°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ Python (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è WEBAPP_HMAC_SECRET
python3 -c "import secrets; print(secrets.token_urlsafe(32))"

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è YFORMS_WEBHOOK_SECRET (–≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –µ—â–µ —Ä–∞–∑ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥—Ä—É–≥–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è)
python3 -c "import secrets; print(secrets.token_urlsafe(32))"
```

**–°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ OpenSSL**

```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ (64 —Å–∏–º–≤–æ–ª–∞)
openssl rand -hex 32

# –ò–ª–∏ base64 (44 —Å–∏–º–≤–æ–ª–∞)
openssl rand -base64 32
```

**–°–ø–æ—Å–æ–± 3: –û–Ω–ª–∞–π–Ω –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä**

–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±–æ–π –æ–Ω–ª–∞–π–Ω –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–ª—É—á–∞–π–Ω—ã—Ö —Å—Ç—Ä–æ–∫, –Ω–∞–ø—Ä–∏–º–µ—Ä:
- https://www.random.org/strings/
- –í—ã–±–µ—Ä–∏—Ç–µ –¥–ª–∏–Ω—É: 32-64 —Å–∏–º–≤–æ–ª–∞
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–∏–º–≤–æ–ª—ã

**–ü—Ä–∏–º–µ—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**

```bash
$ python3 -c "import secrets; print(secrets.token_urlsafe(32))"
xK9mP2qR5vT8wY1zA4bC7eF0hJ3kL6nO9pQ2sU5vX8y

$ python3 -c "import secrets; print(secrets.token_urlsafe(32))"
aB3dE6fG9hI2jK5lM8nO1pQ4rS7tU0vW3xY6zA9bC2eF5h
```

**–í–∞–∂–Ω–æ:**
- –ö–∞–∂–¥—ã–π —Å–µ–∫—Ä–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º (—Ä–∞–∑–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è WEBAPP_HMAC_SECRET –∏ YFORMS_WEBHOOK_SECRET)
- –°–µ–∫—Ä–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª–∏–Ω–Ω—ã–º–∏ (–º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞)
- –•—Ä–∞–Ω–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ - –Ω–µ –ø—É–±–ª–∏–∫—É–π—Ç–µ –∏—Ö –∏ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ –≤ git

### 3.4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ .env

```bash
# –ó–∞—â–∏—Ç–∞ —Ñ–∞–π–ª–∞ .env –æ—Ç —á—Ç–µ–Ω–∏—è –¥—Ä—É–≥–∏–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
chmod 600 .env
```

---

## –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx (–¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è)

### 4.1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Nginx

```bash
sudo apt install -y nginx
```

### 4.2. –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx

```bash
sudo nano /etc/nginx/sites-available/crmbot
```

–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é:

```nginx
server {
    listen 80;
    server_name crmbot.restme.pro;

    # –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ HTTPS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
    # return 301 https://$server_name$request_uri;

    location / {
        proxy_pass http://127.0.0.1:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # –î–ª—è WebSocket (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤ –±—É–¥—É—â–µ–º)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # –¢–∞–π–º–∞—É—Ç—ã
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}
```

### 4.3. –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–æ–π —Å—Å—ã–ª–∫–∏
sudo ln -s /etc/nginx/sites-available/crmbot /etc/nginx/sites-enabled/

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
sudo nginx -t

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Nginx
sudo systemctl reload nginx
```

### 4.4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ HTTPS —Å Let's Encrypt (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Certbot
sudo apt install -y certbot python3-certbot-nginx

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞
sudo certbot --nginx -d crmbot.restme.pro

# Certbot –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx
```

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –æ–±–Ω–æ–≤–∏—Ç–µ `WEBHOOK_BASE_URL` –≤ `.env`:

```bash
WEBHOOK_BASE_URL=https://crmbot.restme.pro
```

---

## –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd —Å–ª—É–∂–±—ã

### 5.1. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å–ª—É–∂–±—ã

```bash
sudo nano /etc/systemd/system/crmbot.service
```

–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (–∑–∞–º–µ–Ω–∏—Ç–µ –ø—É—Ç–∏ –Ω–∞ –≤–∞—à–∏):

```ini
[Unit]
Description=CRM Bot Service
After=network.target

[Service]
Type=simple
User=botuser
Group=botuser
WorkingDirectory=/home/botuser/mgreg-bot
Environment="PATH=/home/botuser/mgreg-bot/.venv/bin"
ExecStart=/home/botuser/mgreg-bot/.venv/bin/python -m bot.main
Restart=always
RestartSec=10

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
StandardOutput=journal
StandardError=journal
SyslogIdentifier=crmbot

# –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
NoNewPrivileges=true
PrivateTmp=true

[Install]
WantedBy=multi-user.target
```

**–í–∞–∂–Ω–æ:** –ó–∞–º–µ–Ω–∏—Ç–µ –≤ —Ñ–∞–π–ª–µ:
- `User=botuser` –Ω–∞ –≤–∞—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–ª–∏ `root`, –µ—Å–ª–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ –æ—Ç root)
- `Group=botuser` –Ω–∞ –≤–∞—à—É –≥—Ä—É–ø–ø—É (–∏–ª–∏ `root`)
- `/home/botuser/mgreg-bot` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É

**–ü—Ä–∏–º–µ—Ä –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è `root` –∏ –ø—É—Ç–∏ `/opt/mgreg-bot`:**
```ini
User=root
Group=root
WorkingDirectory=/opt/mgreg-bot
Environment="PATH=/opt/mgreg-bot/.venv/bin"
ExecStart=/opt/mgreg-bot/.venv/bin/python -m bot.main
```

### 5.2. –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã

```bash
# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ systemd
sudo systemctl daemon-reload

# –í–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
sudo systemctl enable crmbot

# –ó–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã
sudo systemctl start crmbot

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
sudo systemctl status crmbot
```

### 5.3. –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ª–æ–≥–æ–≤
sudo journalctl -u crmbot -f

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 100 —Å—Ç—Ä–æ–∫
sudo journalctl -u crmbot -n 100

# –õ–æ–≥–∏ —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
sudo journalctl -u crmbot --since "1 hour ago"
```

---

## –®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Planfix

### 6.1. –°–æ–∑–¥–∞–Ω–∏–µ –≤–µ–±—Ö—É–∫–∞ –≤ Planfix

1. –í–æ–π–¥–∏—Ç–µ –≤ Planfix
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –≤–µ–±—Ö—É–∫ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
   - **URL**: `http://crmbot.restme.pro/webhooks/planfix-guest` (–∏–ª–∏ `https://` –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω SSL)
   - **–ú–µ—Ç–æ–¥**: POST
   - **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è**: Basic Auth
     - –õ–æ–≥–∏–Ω: –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ `PLANFIX_WEBHOOK_LOGIN`
     - –ü–∞—Ä–æ–ª—å: –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ `PLANFIX_WEBHOOK_PASSWORD`
   - **–°–æ–±—ã—Ç–∏—è**: 
     - `task.created`
     - `task.assignee.manual`
     - `task.wait_form`
     - `task.deadline_failed`
     - `task.cancelled_manual`
     - `task.completed_compensation`
     - `task.deadline_updated`

### 6.2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —à–∞–±–ª–æ–Ω–∞ –∑–∞–¥–∞—á–∏

1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —à–∞–±–ª–æ–Ω –∑–∞–¥–∞—á–∏ "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞" —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
2. –ó–∞–ø–∏—à–∏—Ç–µ ID —à–∞–±–ª–æ–Ω–∞ –∏ —É–∫–∞–∂–∏—Ç–µ –≤ `PLANFIX_TASK_TEMPLATE_IDS`

### 6.3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤

1. –ù–∞–π–¥–∏—Ç–µ ID —Å—Ç–∞—Ç—É—Å–∞ "–ó–∞–≤–µ—Ä—à–µ–Ω–∞/–∫ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏" ‚Üí `STATUS_DONE_ID`
2. –ù–∞–π–¥–∏—Ç–µ ID —Å—Ç–∞—Ç—É—Å–∞ "–û—Ç–º–µ–Ω–µ–Ω–∞" ‚Üí `STATUS_CANCELLED_ID`

### 6.4. –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–ª–µ–π

1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ ‚Üí `RESULT_FIELD_ID`
2. –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–µ —Ç–∏–ø–∞ "–§–∞–π–ª—ã" –¥–ª—è –≤–ª–æ–∂–µ–Ω–∏–π ‚Üí `RESULT_FILES_FIELD_ID`

### 6.5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env —Å ID –∏–∑ Planfix

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Planfix –æ–±–Ω–æ–≤–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ `.env` –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–ª—É–∂–±—É:

```bash
sudo systemctl restart crmbot
```

---

## –®–∞–≥ 7: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ø–Ω–¥–µ–∫—Å –§–æ—Ä–º

### 7.1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫–∞ –≤ –∫–∞–∂–¥–æ–π —Ñ–æ—Ä–º–µ

–î–ª—è –∫–∞–∂–¥–æ–π –∏–∑ 6 —Ñ–æ—Ä–º:

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–æ—Ä–º—É –≤ –Ø–Ω–¥–µ–∫—Å –§–æ—Ä–º–∞—Ö
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–π
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –≤–µ–±—Ö—É–∫:
   - **URL**: `http://crmbot.restme.pro/webhooks/yforms` (–∏–ª–∏ `https://`)
   - **–ú–µ—Ç–æ–¥**: POST
   - **–ü–æ–¥–ø–∏—Å—å**: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ `YFORMS_WEBHOOK_SECRET`
   - **–ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ–¥–ø–∏—Å–∏**: `X-Forms-Signature`

### 7.2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–∫—Ä—ã—Ç—ã—Ö –ø–æ–ª–µ–π

–í –∫–∞–∂–¥–æ–π —Ñ–æ—Ä–º–µ –¥–æ–±–∞–≤—å—Ç–µ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è:
- `sessionId` - ID —Å–µ—Å—Å–∏–∏
- `taskId` - ID –∑–∞–¥–∞—á–∏
- `guestId` - ID –≥–æ—Å—Ç—è
- `formCode` - –∫–æ–¥ —Ñ–æ—Ä–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `delivery_adjika`)

### 7.3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ FORM_URLS –≤ .env

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ `.env` —É–∫–∞–∑–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL –≤—Å–µ—Ö 6 —Ñ–æ—Ä–º:

```bash
FORM_URLS=https://forms.yandex.ru/u/—Ñ–æ—Ä–º–∞1,https://forms.yandex.ru/u/—Ñ–æ—Ä–º–∞2,...
```

---

## –®–∞–≥ 8: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 8.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–ª—É–∂–±—ã
sudo systemctl status crmbot

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–µ–±—Ö—É–∫–∞-—Å–µ—Ä–≤–µ—Ä–∞
curl http://localhost:8001/webhooks/planfix-guest

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –ø—É–±–ª–∏—á–Ω—ã–π URL
curl http://crmbot.restme.pro/webhooks/planfix-guest
```

### 8.2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
sudo journalctl -u crmbot -f

# –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫
sudo journalctl -u crmbot | grep -i error
```

### 8.3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

1. **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≥–æ—Å—Ç—è:**
   - –û—Ç–∫—Ä–æ–π—Ç–µ Telegram –±–æ—Ç–∞
   - –û—Ç–ø—Ä–∞–≤—å—Ç–µ `/start`
   - –ü—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é

2. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ Planfix:**
   - –°–æ–∑–¥–∞–π—Ç–µ –∑–∞–¥–∞—á—É –ø–æ —à–∞–±–ª–æ–Ω—É "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞"
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: –¥–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≤–µ–±—Ö—É–∫–∞

3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π:**
   - –ì–æ—Å—Ç–∏ –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –≤ Telegram
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø–∏—Å–µ–π –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ

4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WebApp:**
   - –ü—Ä–∏–º–∏—Ç–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
   - –ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ"
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ WebApp –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è

---

## –®–∞–≥ 9: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 9.1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞

–°–ª—É–∂–±–∞ —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ systemd (`Restart=always`).

### 9.2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞

```bash
# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ cron –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
crontab -e

# –î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å)
0 * * * * df -h | mail -s "Disk usage" your-email@example.com
```

### 9.3. –†–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤

–õ–æ–≥–∏ systemd –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–æ—Ç–∏—Ä—É—é—Ç—Å—è. –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ä–æ—Ç–∞—Ü–∏–∏
sudo journalctl --disk-usage

# –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤ (–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π)
sudo journalctl --vacuum-time=7d
```

---

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –∑–∞–ø—É—Å–∫–∞ (–±–µ–∑ systemd)

–ï—Å–ª–∏ –≤—ã –Ω–µ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å systemd —Å–ª—É–∂–±—É, –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å –¥—Ä—É–≥–∏–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏:

### –°–ø–æ—Å–æ–± 1: –ü—Ä–æ—Å—Ç–æ–π –∑–∞–ø—É—Å–∫ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ

**–ü—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫:**
```bash
# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd ~/mgreg-bot

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
source .venv/bin/activate

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
python -m bot.main
```

**–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:**
```bash
./run.sh
```

**–û—Å—Ç–∞–Ω–æ–≤–∫–∞:** –ù–∞–∂–º–∏—Ç–µ `Ctrl+C` –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ

‚ö†Ô∏è **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫:** –ü—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ –∏–ª–∏ —Ä–∞–∑—Ä—ã–≤–µ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.

---

### –°–ø–æ—Å–æ–± 2: –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ —Å nohup

**–ó–∞–ø—É—Å–∫:**
```bash
# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd ~/mgreg-bot

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
source .venv/bin/activate

# –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ —Å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –ª–æ–≥–æ–≤
nohup python -m bot.main > bot.log 2>&1 &

# –ó–∞–ø–æ–º–Ω–∏—Ç–µ PID –ø—Ä–æ—Ü–µ—Å—Å–∞ (–æ–Ω –±—É–¥–µ—Ç –≤—ã–≤–µ–¥–µ–Ω)
echo $! > bot.pid
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞
ps aux | grep "bot.main"

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
tail -f bot.log
```

**–û—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
# –ß—Ç–µ–Ω–∏–µ PID –∏–∑ —Ñ–∞–π–ª–∞
kill $(cat bot.pid)

# –ò–ª–∏ –Ω–∞–π–¥–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –≤—Ä—É—á–Ω—É—é
ps aux | grep "bot.main"
kill <PID>
```

---

### –°–ø–æ—Å–æ–± 3: –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ screen

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ screen (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω):**
```bash
sudo apt install screen
```

**–ó–∞–ø—É—Å–∫:**
```bash
# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd ~/mgreg-bot

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
source .venv/bin/activate

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π screen-—Å–µ—Å—Å–∏–∏
screen -S crmbot

# –í–Ω—É—Ç—Ä–∏ screen –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å
python -m bot.main

# –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç screen: –Ω–∞–∂–º–∏—Ç–µ Ctrl+A, –∑–∞—Ç–µ–º D
# (—Å–µ—Å—Å–∏—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ñ–æ–Ω–µ)
```

**–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Å—Å–∏–∏:**
```bash
# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π
screen -ls

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Å—Å–∏–∏
screen -r crmbot
```

**–û—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Å—Å–∏–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C
screen -r crmbot
# –ó–∞—Ç–µ–º Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
```

---

### –°–ø–æ—Å–æ–± 4: –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ tmux

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ tmux (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω):**
```bash
sudo apt install tmux
```

**–ó–∞–ø—É—Å–∫:**
```bash
# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd ~/mgreg-bot

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
source .venv/bin/activate

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π tmux-—Å–µ—Å—Å–∏–∏
tmux new -s crmbot

# –í–Ω—É—Ç—Ä–∏ tmux –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å
python -m bot.main

# –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç tmux: –Ω–∞–∂–º–∏—Ç–µ Ctrl+B, –∑–∞—Ç–µ–º D
# (—Å–µ—Å—Å–∏—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ñ–æ–Ω–µ)
```

**–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Å—Å–∏–∏:**
```bash
# –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π
tmux ls

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Å—Å–∏–∏
tmux attach -t crmbot
```

**–û—Å—Ç–∞–Ω–æ–≤–∫–∞:**
```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Å—Å–∏–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C
tmux attach -t crmbot
# –ó–∞—Ç–µ–º Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
```

---

### –°–ø–æ—Å–æ–± 5: –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Supervisor (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ systemd)

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Supervisor:**
```bash
sudo apt install supervisor
```

**–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:**
```bash
sudo nano /etc/supervisor/conf.d/crmbot.conf
```

**–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (–∑–∞–º–µ–Ω–∏—Ç–µ –ø—É—Ç–∏ –Ω–∞ –≤–∞—à–∏):**
```ini
[program:crmbot]
command=/home/botuser/mgreg-bot/.venv/bin/python -m bot.main
directory=/home/botuser/mgreg-bot
user=botuser
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
stderr_logfile=/var/log/crmbot.err.log
stdout_logfile=/var/log/crmbot.out.log
environment=PATH="/home/botuser/mgreg-bot/.venv/bin"
```

**–ê–∫—Ç–∏–≤–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫:**
```bash
# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
sudo supervisorctl reread
sudo supervisorctl update

# –ó–∞–ø—É—Å–∫
sudo supervisorctl start crmbot

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
sudo supervisorctl status crmbot

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
sudo tail -f /var/log/crmbot.out.log
```

**–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
```bash
# –ó–∞–ø—É—Å–∫
sudo supervisorctl start crmbot

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
sudo supervisorctl stop crmbot

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
sudo supervisorctl restart crmbot

# –°—Ç–∞—Ç—É—Å
sudo supervisorctl status crmbot
```

---

### –°–ø–æ—Å–æ–± 6: –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker

–ï—Å–ª–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ Docker:

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞–∑–∞
docker build -t crmbot .

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker run -d \
  --name crmbot \
  --restart unless-stopped \
  --env-file .env \
  -p 8001:8001 \
  crmbot

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker logs -f crmbot

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker stop crmbot
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `docker-compose`:
```bash
docker-compose up -d

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker-compose logs -f

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
docker-compose down
```

---

## –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É–∂–±–æ–π (systemd)

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ó–∞–ø—É—Å–∫
sudo systemctl start crmbot

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞
sudo systemctl stop crmbot

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
sudo systemctl restart crmbot

# –°—Ç–∞—Ç—É—Å
sudo systemctl status crmbot

# –í–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
sudo systemctl enable crmbot

# –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
sudo systemctl disable crmbot

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
sudo journalctl -u crmbot -f
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ (–¥–ª—è systemd)

```bash
# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd ~/mgreg-bot

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ª—É–∂–±—ã
sudo systemctl stop crmbot

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ git)
git pull

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
source .venv/bin/activate

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è requirements.txt)
pip install -r requirements.txt

# –ó–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã
sudo systemctl start crmbot

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
sudo systemctl status crmbot
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ (–¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–µ–∑ systemd)

**–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ nohup:**
```bash
cd ~/mgreg-bot
kill $(cat bot.pid)  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞
source .venv/bin/activate
git pull
pip install -r requirements.txt
nohup python -m bot.main > bot.log 2>&1 &
echo $! > bot.pid
```

**–ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ screen/tmux:**
```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Å—Å–∏–∏
screen -r crmbot  # –∏–ª–∏ tmux attach -t crmbot

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å (Ctrl+C)
# –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥
cd ~/mgreg-bot
source .venv/bin/activate
git pull
pip install -r requirements.txt

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–æ–≤–∞
python -m bot.main
```

---

## –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –ü—Ä–æ–±–ª–µ–º–∞: –°–ª—É–∂–±–∞ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
sudo systemctl status crmbot

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –ª–æ–≥–æ–≤
sudo journalctl -u crmbot -n 50

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º
ls -la ~/mgreg-bot/.env
ls -la ~/mgreg-bot/bot.db
```

### –ü—Ä–æ–±–ª–µ–º–∞: –í–µ–±—Ö—É–∫ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–ª—É–∂–±–∞ —Å–ª—É—à–∞–µ—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—Ç—É
sudo netstat -tulpn | grep 8001

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª firewall
sudo ufw status

# –û—Ç–∫—Ä—ã—Ç–∏–µ –ø–æ—Ä—Ç–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
sudo ufw allow 8001/tcp
```

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Planfix

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ `.env`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Planfix API:
   ```bash
   curl -H "Authorization: Bearer YOUR_TOKEN" https://conquest.planfix.ru/rest/contact/templates
   ```

### –ü—Ä–æ–±–ª–µ–º–∞: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å
ls -la ~/mgreg-bot/

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –ë–î (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
mkdir -p ~/mgreg-bot
chmod 755 ~/mgreg-bot
```

---

## –ë—ç–∫–∞–ø—ã

### –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –±—ç–∫–∞–ø–∞
nano ~/backup.sh
```

–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–∫—Ä–∏–ø—Ç–∞:

```bash
#!/bin/bash
BACKUP_DIR="/home/botuser/backups"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR
cp ~/mgreg-bot/bot.db $BACKUP_DIR/bot_$DATE.db
# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (—Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π)
find $BACKUP_DIR -name "bot_*.db" -mtime +7 -delete
```

```bash
# –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x ~/backup.sh

# –î–æ–±–∞–≤–ª—è–µ–º –≤ cron (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00)
crontab -e
# –î–æ–±–∞–≤–∏—Ç—å: 0 3 * * * /home/botuser/backup.sh
```

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –õ–æ–≥–∏ —Å–ª—É–∂–±—ã: `sudo journalctl -u crmbot -f`
2. –õ–æ–≥–∏ Nginx: `sudo tail -f /var/log/nginx/error.log`
3. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ `.env`
4. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Planfix –∏ –Ø–Ω–¥–µ–∫—Å –§–æ—Ä–º–∞—Ö

---

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Docker (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):**
   –ï—Å–ª–∏ –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ Docker, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `docker-compose.yml`:
   ```bash
   docker-compose up -d
   ```

2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:**
   –†–µ–≥—É–ª—è—Ä–Ω–æ –¥–µ–ª–∞–π—Ç–µ –±—ç–∫–∞–ø—ã `.env` –∏ `bot.db`

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤:**
   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `htop` –∏–ª–∏ `top` –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤

4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:**
   –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —Å–∏—Å—Ç–µ–º—É:
   ```bash
   sudo apt update && sudo apt upgrade -y
   ```

