# Руководство по настройке системы автоматизации приглашений

## Обзор

Система автоматизирует процесс приглашения тайных гостей на проверки ресторанов и обработку результатов через Telegram бота и интеграцию с Planfix.

## Компоненты

1. **Telegram Bot** - регистрация гостей, рассылка приглашений, обработка ответов
2. **Webhook Server** - прием событий из Planfix и Яндекс Форм
3. **Database (SQLite)** - хранение задач, приглашений, сессий форм
4. **Scheduler** - автоматическая проверка дедлайнов

## Установка

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка переменных окружения

Скопируйте `env.example` в `.env` и заполните все переменные:

```bash
cp env.example .env
```

#### Обязательные переменные:

- `BOT_TOKEN` - токен Telegram бота
- `PLANFIX_BASE_URL` - базовый URL Planfix API
- `PLANFIX_TOKEN` - токен доступа Planfix
- `WEBAPP_HMAC_SECRET` - секрет для подписи WebApp URL
- `YFORMS_WEBHOOK_SECRET` - секрет для вебхуков Яндекс Форм
- `WEBHOOK_BASE_URL` - публичный URL вашего сервера (для WebApp)

#### Опциональные переменные:

- `PLANFIX_WEBHOOK_LOGIN` - логин для Basic Auth вебхуков Planfix
- `PLANFIX_WEBHOOK_PASSWORD` - пароль для Basic Auth вебхуков Planfix
- `PLANFIX_TASK_TEMPLATE_IDS` - ID шаблонов задач через запятую
- `STATUS_DONE_ID` - ID статуса "Завершена"
- `STATUS_CANCELLED_ID` - ID статуса "Отменена"
- `RESULT_FIELD_ID` - ID кастомного поля для результатов
- `RESULT_FILES_FIELD_ID` - ID кастомного поля для файлов
- `FORM_URLS` - URL форм через запятую (6 форм: resto_a,resto_b,resto_c,delivery_a,delivery_b,delivery_c)

### 3. Настройка Planfix

1. **Создайте вебхук в Planfix:**
   - URL: `http://crmbot.restme.pro/webhooks/planfix-guest`
   - Метод: POST
   - События: `task.created`, `task.updated`
   - Аутентификация: Basic Auth (логин и пароль)
   - Укажите логин и пароль в `.env` файле:
     - `PLANFIX_WEBHOOK_LOGIN` - логин для вебхука
     - `PLANFIX_WEBHOOK_PASSWORD` - пароль для вебхука

2. **Настройте шаблон задачи "Проверка ресторана":**
   - Убедитесь, что шаблон имеет необходимые поля
   - Запишите ID шаблона в `PLANFIX_TASK_TEMPLATE_IDS`

3. **Настройте статусы:**
   - Запишите ID статуса "Завершена/к компенсации" в `STATUS_DONE_ID`
   - Запишите ID статуса "Отменена" в `STATUS_CANCELLED_ID`

4. **Создайте кастомные поля:**
   - Поле для результатов (текст) - ID в `RESULT_FIELD_ID`
   - Поле для файлов (файл) - ID в `RESULT_FILES_FIELD_ID`

### 4. Настройка Яндекс Форм

1. **Настройте вебхуки в каждой форме:**
   - URL: `http://crmbot.restme.pro/webhooks/yforms`
   - Метод: POST
   - Подпись: используйте `YFORMS_WEBHOOK_SECRET`

2. **Добавьте скрытые поля в формы:**
   - `sessionId` - ID сессии
   - `taskId` - ID задачи
   - `guestId` - ID гостя
   - `form` - тип формы (resto_a, resto_b, и т.д.)

3. **Настройте отправку данных:**
   - Формат: JSON
   - Поля: `score`, `summary`, `raw` (полные ответы), `attachments` (файлы)

### 5. Запуск

```bash
python -m bot.main
```

Бот запустится в режиме polling, вебхук-сервер на порту 8000 (по умолчанию).

## Использование

### Регистрация гостя

1. Гость отправляет `/start` боту
2. Проходит регистрацию (телефон, ФИО, дата рождения, город)
3. Данные сохраняются в Planfix и создается связь `planfix_contact_id ↔ telegram_id`

### Создание задачи проверки

1. Администратор создает задачу в Planfix по шаблону "Проверка ресторана"
2. В задаче указываются:
   - Ресторан (название, адрес)
   - Дата проверки
   - Дедлайн
   - Список приглашенных гостей (ID контактов)
3. Planfix отправляет вебхук `task.created`
4. Бот автоматически рассылает приглашения всем указанным гостям

### Принятие приглашения

1. Гость получает сообщение с кнопками "Принять" / "Отказаться"
2. При нажатии "Принять":
   - Проверяется, не назначен ли уже исполнитель
   - Первый принявший назначается исполнителем
   - Остальные получают уведомление "Исполнитель уже найден"
   - Принявшему отправляется кнопка "Начать прохождение"

### Прохождение проверки

1. Гость нажимает "Начать прохождение"
2. Открывается WebApp с информацией о задаче
3. При нажатии "Открыть форму" происходит редирект на Яндекс Форму
4. Гость заполняет форму и отправляет
5. Яндекс Форма отправляет вебхук с результатами
6. Результаты сохраняются в Planfix:
   - В кастомное поле задачи
   - Файлы загружаются в задачу
   - Добавляется комментарий
   - Статус меняется на "Завершена"
7. Администратор получает уведомление

### Дедлайн

1. При создании задачи планируется проверка дедлайна
2. В момент дедлайна проверяется, была ли сдана форма
3. Если форма не сдана:
   - Статус меняется на "Отменена"
   - Добавляется комментарий
   - Администратор получает уведомление

## API Endpoints

### POST /webhooks/planfix-guest
Принимает события из Planfix при создании/обновлении задач для автоматизации приглашений тайных гостей.
Требует Basic Auth аутентификации (логин/пароль).

### GET /webapp/start
WebApp для отображения информации о задаче и редиректа на форму.

Параметры:
- `taskId` - ID задачи
- `guestId` - ID гостя
- `form` - тип формы
- `sig` - подпись HMAC
- `ts` - timestamp

### POST /webhooks/yforms
Принимает результаты заполнения форм из Яндекс Форм.

## База данных

SQLite база данных (`bot.db` по умолчанию) содержит:

- `tasks` - задачи проверок
- `invitations` - отправленные приглашения
- `guest_telegram_map` - связь контактов Planfix с Telegram
- `form_sessions` - сессии заполнения форм

## Логирование

Все ключевые события логируются в структурированном JSON формате:
- Создание задач
- Отправка приглашений
- Принятие/отказ от приглашений
- Заполнение форм
- Обработка дедлайнов

## Безопасность

- Вебхуки Planfix защищены Basic Auth (логин/пароль)
- Вебхуки Яндекс Форм проверяются по HMAC подписи
- WebApp URLs подписываются для предотвращения подделки
- Секреты и пароли хранятся только в переменных окружения
- Идемпотентность обработки вебхуков (защита от дублей)

## Troubleshooting

### Приглашения не отправляются
- Проверьте, что вебхук из Planfix настроен правильно
- Убедитесь, что в настройках вебхука указаны правильные логин и пароль (Basic Auth)
- Проверьте логи на наличие ошибок аутентификации (401)
- Убедитесь, что в задаче указаны приглашенные гости
- Проверьте, что у гостей есть связь `planfix_contact_id ↔ telegram_id`

### WebApp не открывается
- Проверьте `WEBHOOK_BASE_URL` - должен быть публичным URL
- Убедитесь, что подпись генерируется правильно
- Проверьте логи на наличие ошибок

### Формы не обрабатываются
- Проверьте настройку вебхуков в Яндекс Формах
- Убедитесь, что подпись верифицируется правильно
- Проверьте формат данных, отправляемых формой

## Поддержка

При возникновении проблем проверьте логи и убедитесь, что все переменные окружения заполнены правильно.




